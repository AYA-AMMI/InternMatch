{% extends 'admin/base.html.twig' %}

{% block page_title %}Internships Overview{% endblock %}

{% block admin_stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/admin/internships.css') }}" />
{% endblock %}

{% block admin_content %}
<div class="internships-container">
    
    <div class="page-header">
        <div>
            <h2><i class="fas fa-briefcase"></i> All Internships</h2>
            <p class="text-muted">Manage and moderate all internship postings</p>
        </div>
    </div>

    {# Filters Section #}
    <div class="filters-section">
        <form method="GET" action="{{ path('admin_internships') }}" class="filters-form">
            <div class="row g-3">
                {# Search Input #}
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" name="search" class="form-control" 
                               placeholder="Search by title or company..." 
                               value="{{ currentSearch }}">
                    </div>
                </div>

                {# Status Filter #}
                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="active" {{ currentStatus == 'active' ? 'selected' : '' }}>Active</option>
                        <option value="closed" {{ currentStatus == 'closed' ? 'selected' : '' }}>Closed</option>
                    </select>
                </div>

                {# Industry Filter #}
                <div class="col-md-3">
                    <select name="industry" class="form-select">
                        <option value="">All Industries</option>
                        {% for industry in industries %}
                            <option value="{{ industry }}" {{ currentIndustry == industry ? 'selected' : '' }}>
                                {{ industry }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Filter Buttons #}
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </div>

            {# Clear Filters #}
            {% if currentSearch or currentStatus or currentIndustry %}
                <div class="mt-2">
                    <a href="{{ path('admin_internships') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear All Filters
                    </a>
                </div>
            {% endif %}
        </form>
    </div>

    {# Results Info #}
    <div class="results-info">
        <p><strong>{{ internships|length }}</strong> internship(s) found</p>
    </div>

    {# Internships Table #}
    <div class="table-responsive">
        {% if internships is empty %}
            <div class="empty-state">
                <i class="fas fa-briefcase-blank"></i>
                <p>No internships found with the current filters</p>
            </div>
        {% else %}
            <table class="table table-hover internships-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Company</th>
                        <th>Industry</th>
                        <th>Location</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Applications</th>
                        <th>Posted</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for internship in internships %}
                        <tr>
                            <td>#{{ internship.id }}</td>
                            <td>
                                <div class="internship-title">
                                    <strong>{{ internship.title }}</strong>
                                    {% if internship.deadline %}
                                        <small class="text-muted d-block">
                                            Deadline: {{ internship.deadline|date('M d, Y') }}
                                        </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="company-info">
                                    <i class="fas fa-building"></i>
                                    <div>
                                        <strong>{{ internship.company.companyName }}</strong>
                                        {% if not internship.company.isVerified %}
                                            <span class="badge badge-warning badge-sm">Unverified</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="industry-badge">{{ internship.company.industry }}</span>
                            </td>
                            <td>
                                <i class="fas fa-map-marker-alt text-muted"></i>
                                {{ internship.location }}
                            </td>
                            <td>{{ internship.duration }} months</td>
                            <td>
                                <span class="badge {{ internship.status == 'active' ? 'badge-success' : 'badge-secondary' }}">
                                    {{ internship.status|capitalize }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-info">
                                    {{ internship.applications|length }} applications
                                </span>
                            </td>
                            <td>{{ internship.postedAt|date('M d, Y') }}</td>
                            <td>
                                <div class="action-buttons">
                                    {# View Skills Button #}
                                    <button type="button" 
                                            class="btn btn-sm btn-info" 
                                            onclick="showInternshipDetails({{ internship.id }})"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>

                                    {# Toggle Status Button #}
                                    <form method="POST" 
                                          action="{{ path('admin_internship_toggle_status', {id: internship.id}) }}" 
                                          style="display: inline;">
                                        <button type="submit" 
                                                class="btn btn-sm {{ internship.status == 'active' ? 'btn-warning' : 'btn-success' }}" 
                                                title="{{ internship.status == 'active' ? 'Deactivate' : 'Activate' }}">
                                            <i class="fas {{ internship.status == 'active' ? 'fa-pause' : 'fa-play' }}"></i>
                                        </button>
                                    </form>

                                    {# Bouton Delete qui ouvre le modal #}
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteInternshipModal{{
                                            internship.id
                                        }}"
                                        title="Delete Internship"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% for internship in internships %} {# Modal Delete Internship #}
                <div
                    class="modal fade"
                    id="deleteInternshipModal{{ internship.id }}"
                    tabindex="-1"
                    aria-labelledby="deleteInternshipModalLabel{{ internship.id }}"
                    aria-hidden="true"
                >
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            {# Header #}
                            <div class="modal-header bg-danger text-white">
                                <h5
                                    class="modal-title"
                                    id="deleteInternshipModalLabel{{ internship.id }}"
                                >
                                    <i
                                        class="fas fa-exclamation-triangle me-2"
                                    ></i>
                                    Confirm Deletion
                                </h5>
                                <button
                                    type="button"
                                    class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"
                                ></button>
                            </div>

                            {# Body #}
                            <div class="modal-body">
                                <p class="mb-3">
                                    <strong
                                        >Are you sure you want to delete this
                                        Internship?</strong
                                    >
                                </p>

                                <div class="alert alert-light border">
                                    <p class="mb-1">
                                        <i class="fas fa-user text-primary"></i>
                                        <strong
                                            >{{ internship.title }}</strong>
                                    </p>
                                    <p class="mb-1">
                                        <i
                                            class="fas fa-envelope text-muted"
                                        ></i>
                                        {{ internship.description }}
                                    </p>
                                </div>

                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <strong>Warning:</strong> This action cannot
                                    be undone. All internship data
                                    will be permanently deleted.
                                </div>
                            </div>

                            {# Footer #}
                            <div class="modal-footer">
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    data-bs-dismiss="modal"
                                >
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <form
                                    method="POST"
                                    action="{{
                                        path('admin_internship_delete', {
                                            id: internship.id
                                        })
                                    }}"
                                    style="display: inline"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-danger"
                                    >
                                        <i class="fas fa-trash"></i> Delete
                                        Internship
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
        {% endif %}
    </div>

</div>

{# Internship Details Modal #}
<div class="modal fade" id="internshipDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-briefcase"></i> Internship Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="internshipDetailsBody">
                {# Content will be dynamically loaded #}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{# Hidden data for JavaScript #}
<div id="internshipsData" style="display: none;">
    {% for internship in internships %}
        <div data-id="{{ internship.id }}" 
             data-title="{{ internship.title }}"
             data-description="{{ internship.description }}"
             data-skills="{{ internship.requiredSkills|json_encode }}"
             data-location="{{ internship.location }}"
             data-duration="{{ internship.duration }}"
             data-salary="{{ internship.salary }}">
        </div>
    {% endfor %}
</div>

{% endblock %}

{% block admin_javascripts %}
    <script src="{{ asset('js/admin/internships.js') }}"></script>
{% endblock %}